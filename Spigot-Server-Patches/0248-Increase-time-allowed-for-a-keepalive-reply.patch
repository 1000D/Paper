From e80c24c1c7a322ed157a4aecb8916ac7d1df6a83 Mon Sep 17 00:00:00 2001
From: Shane Freeder <theboyetronic@gmail.com>
Date: Tue, 31 Oct 2017 21:07:06 -0400
Subject: [PATCH] Increase time allowed for a keepalive reply

This patch intends to bump up the time that a client has to reply to the
server back to 30 seconds as per pre 1.12.2, which allowed clients
more than enough time to reply potentially allowing them to be less
tempermental due to lag spikes on the network thread, e.g. that caused
by plugins that are interacting with netty.

diff --git a/src/main/java/net/minecraft/network/NetHandlerPlayServer.java b/src/main/java/net/minecraft/network/NetHandlerPlayServer.java
index 92288fa..ee50058 100644
--- a/src/main/java/net/minecraft/network/NetHandlerPlayServer.java
+++ b/src/main/java/net/minecraft/network/NetHandlerPlayServer.java
@@ -342,18 +342,28 @@ public class NetHandlerPlayServer implements INetHandlerPlayServer, ITickable {
         }
 
         this.serverController.profiler.startSection("keepAlive");
-        long i = this.currentTimeMillis();
-
-        if (i - this.field_194402_f >= 25000L) {
-            if (this.field_194403_g) {
-                this.disconnect(new TextComponentTranslation("disconnect.timeout", new Object[0]));
-            } else {
-                this.field_194403_g = true;
-                this.field_194402_f = i;
-                this.field_194404_h = i;
-                this.sendPacket(new SPacketKeepAlive(this.field_194404_h));
+        // Paper Start - give clients a longer time to respond to pings as per pre 1.12.2 timings
+        // This should effectively place the keepalive handling back to "as it was" before 1.12.2
+
+        // These keepalive fields were not mapped in MCP - I've opened a ticket to get them mapped but
+        // in the meantime they're all commented - https://github.com/ModCoderPack/MCPBot-Issues/issues/563
+        long currentTime = this.currentTimeMillis();
+        long elapsedTime = currentTime - this.field_194402_f; // lastKeepAliveTime
+        if (this.field_194403_g) { // pendingPing
+            // We're pending a ping from the client
+            if (!this.processedDisconnect && elapsedTime >= 30000L) { // 30 seconds for a ping reply also, don't fire if already disconnected
+                LOGGER.warn("{} was kicked due to keepalive timeout!", this.player.getName()); // more info
+                this.disconnect(new TextComponentTranslation("disconnect.timeout"));
+            }
+        } else {
+            if (elapsedTime >= 15000L) { // 15 seconds
+                this.field_194403_g = true; // pendingKeepAlive
+                this.field_194402_f = currentTime; // lastKeepAliveTime
+                this.field_194404_h = currentTime; // keepAliveId
+                this.sendPacket(new SPacketKeepAlive(this.field_194404_h)); // keepAliveId
             }
         }
+        // Paper end
 
         this.serverController.profiler.endSection();
 
-- 
2.14.3.windows.1

